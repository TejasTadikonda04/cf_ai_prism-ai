<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prism AI | Synesthesia Engine</title>
    <style>
        :root {
            --bg: #111;
            --text: #eee;
            --accent: #333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            transition: background 1.5s ease; /* Smooth color fade */
        }
        .container {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 { margin-bottom: 0.5rem; font-weight: 300; letter-spacing: 2px; }
        p { color: #aaa; font-size: 0.9rem; margin-bottom: 2rem; }
        
        textarea {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            resize: none;
            height: 80px;
            font-size: 1rem;
            margin-bottom: 1rem;
            box-sizing: border-box; /* Fix padding issues */
        }
        textarea:focus { outline: none; border-color: #777; }

        button {
            width: 100%;
            padding: 1rem;
            background: white;
            color: black;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .palette {
            display: flex;
            margin-top: 2rem;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s ease;
        }
        .palette.visible { opacity: 1; transform: translateY(0); }
        .swatch {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.8);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
        }
        .swatch:hover { flex: 1.5; transition: flex 0.3s ease; }

        .history {
            margin-top: 3rem;
            text-align: left;
            width: 100%;
        }
        .history-item {
            font-size: 0.8rem;
            color: #888;
            padding: 0.5rem 0;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>PRISM AI</h1>
        <p>The Synesthesia Engine. Type a feeling, get a color.</p>

        <textarea id="input" placeholder="e.g. A cyberpunk city in the rain..."></textarea>
        <button id="btn" onclick="generate()">Generate Palette</button>

        <div class="palette" id="paletteBox">
            </div>
        
        <h2 id="paletteName" style="margin-top: 1rem; font-size: 1.2rem; opacity: 0;"></h2>
    </div>

    <div class="container history" style="margin-top: 1rem;">
        <div style="font-size: 0.8rem; font-weight: bold; margin-bottom: 0.5rem;">HISTORY</div>
        <div id="historyList">Loading...</div>
    </div>

    <script>
        // Generate a random User ID for the session (for the Durable Object)
        const userId = localStorage.getItem('prism_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('prism_uid', userId);

        // 1. GENERATE FUNCTION
        async function generate() {
            const text = document.getElementById('input').value;
            const btn = document.getElementById('btn');
            
            if(!text) return;

            btn.innerText = "Dreaming...";
            btn.disabled = true;

            try {
                const res = await fetch('http://localhost:8787/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, userId })
                });

                const data = await res.json();
                
                // Check if the response contains an error
                if (data.error) {
                    alert("Error: " + data.error + (data.details ? "\nDetails: " + data.details : ""));
                    return;
                }

                // Validate the data structure before rendering
                if (!data || !data.colors || !Array.isArray(data.colors)) {
                    alert("Invalid response from server. Expected colors array.");
                    console.error("Invalid data:", data);
                    return;
                }

                renderPalette(data);
                // Wait a bit for the save to complete before refreshing history
                setTimeout(() => {
                    loadHistory(); // Refresh history list
                }, 500); // 500ms delay to ensure save completes

            } catch (e) {
                alert("Error connecting to AI: " + e.message);
                console.error("Fetch error:", e);
            }

            btn.innerText = "Generate Palette";
            btn.disabled = false;
        }

        // 2. RENDER UI
        function renderPalette(data) {
            const box = document.getElementById('paletteBox');
            const name = document.getElementById('paletteName');

            // Validate data structure
            if (!data || !data.colors || !Array.isArray(data.colors) || data.colors.length === 0) {
                console.error("Invalid palette data:", data);
                return;
            }

            // Clear old colors
            box.innerHTML = '';
            
            data.colors.forEach(hex => {
                const div = document.createElement('div');
                div.className = 'swatch';
                div.style.backgroundColor = hex;
                div.innerText = hex;
                div.onclick = () => navigator.clipboard.writeText(hex); // Click to copy
                box.appendChild(div);
            });

            name.innerText = data.name || "Unnamed Palette";
            name.style.opacity = 1;
            box.classList.add('visible');

            // Apply the vibe to the whole body background
            if (data.colors[0]) {
                document.body.style.background = `radial-gradient(circle at center, ${data.colors[0]}, #111)`;
            }
        }

        // 3. LOAD HISTORY (From Durable Object)
        async function loadHistory() {
            const list = document.getElementById('historyList');
            try {
                const res = await fetch(`http://localhost:8787/api/history?userId=${userId}`);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const history = await res.json();
                
                // Check if response contains an error
                if (history.error) {
                    list.innerHTML = `<div style="padding:10px; text-align:center; color:#888;">Error loading history: ${history.error}</div>`;
                    return;
                }
                
                list.innerHTML = '';
                const items = Object.values(history);

                if (items.length === 0) {
                    list.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">No history yet</div>';
                    return;
                }

                items.forEach(item => {
                    // Validate item structure
                    if (!item || !item.colors || !Array.isArray(item.colors)) {
                        console.warn("Invalid history item:", item);
                        return;
                    }
                    
                    const row = document.createElement('div');
                    row.className = 'history-item';
                    row.innerHTML = `
                        <span>${item.name || "Unnamed Palette"}</span>
                        <div style="display:flex; gap:2px">
                            ${item.colors.map(c => `<div style="width:10px; height:10px; background:${c}; border-radius:2px;"></div>`).join('')}
                        </div>
                    `;
                    row.onclick = () => renderPalette(item); // Click history to restore
                    row.style.cursor = 'pointer';
                    list.appendChild(row);
                });
            } catch (e) {
                console.error("History load error:", e);
                list.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">Could not load history</div>';
            }
        }

        // Load history on startup
        loadHistory();
    </script>
</body>
</html>